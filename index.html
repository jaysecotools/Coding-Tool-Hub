<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jay's Coding Hub</title>
<meta name="description" content="Jay's Coding Hub â€” an organised place for web utilities and small tools." />
<link rel="icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #4361ee;
    --primary-light: #4895ef;
    --secondary: #3a0ca3;
    --dark: #1e1e2e;
    --darker: #121212;
    --light: #f8f9fa;
    --lighter: #ffffff;
    --gray: #6c757d;
    --gray-light: #adb5bd;
    --gray-lighter: #e9ecef;
    --success: #4cc9f0;
    --warning: #f72585;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
    --transition: all 0.3s ease;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    line-height: 1.6;
    color: var(--dark);
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  body {
    padding: 0;
    display: flex;
    justify-content: center;
    overflow-x: hidden;
  }

  .app-container {
    width: 100%;
    max-width: 1400px;
    padding: 24px;
  }

  /* Header Styles */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding: 20px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }

  .logo-inner {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .code-symbol {
    font-family: monospace;
    font-weight: 700;
    font-size: 1.8rem;
    position: relative;
  }

  .code-symbol::before {
    content: "<>";
    color: white;
  }

  .brand-text h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--darker);
    letter-spacing: -0.5px;
  }

  .brand-text .subtitle {
    margin: 4px 0 0;
    color: var(--gray);
    font-size: 1rem;
    font-weight: 400;
  }

  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* Button Styles */
  .btn {
    border: none;
    padding: 10px 18px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
  }

  .btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
  }

  .btn.secondary {
    background: transparent;
    color: var(--primary);
    border: 1px solid rgba(67, 97, 238, 0.2);
  }

  .btn.secondary:hover {
    background: rgba(67, 97, 238, 0.05);
    border-color: rgba(67, 97, 238, 0.4);
  }

  /* Search and Filter */
  .filters {
    display: flex;
    gap: 16px;
    margin-bottom: 28px;
    align-items: center;
  }

  .search {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    border-radius: var(--radius);
    background: var(--lighter);
    box-shadow: var(--shadow);
    border: 1px solid transparent;
    transition: var(--transition);
  }

  .search:focus-within {
    border-color: var(--primary-light);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
  }

  .search svg {
    flex-shrink: 0;
  }

  .search input {
    border: 0;
    outline: none;
    font-size: 1rem;
    background: transparent;
    width: 100%;
    color: var(--dark);
  }

  .search input::placeholder {
    color: var(--gray-light);
  }

  select.category {
    min-width: 180px;
    padding: 14px 16px;
    border-radius: var(--radius);
    border: 1px solid var(--gray-lighter);
    background: var(--lighter);
    font-size: 0.95rem;
    color: var(--dark);
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: var(--transition);
  }

  select.category:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
  }

  /* Tag Filter */
  .tag-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
    align-items: center;
  }

  .tag-filter {
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(67, 97, 238, 0.1);
    color: var(--primary);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid transparent;
  }

  .tag-filter:hover {
    background: rgba(67, 97, 238, 0.2);
  }

  .tag-filter.active {
    background: var(--primary);
    color: white;
  }

  .clear-tags {
    font-size: 0.85rem;
    color: var(--gray);
    cursor: pointer;
    text-decoration: underline;
    margin-left: 8px;
  }

  .clear-tags:hover {
    color: var(--primary);
  }

  /* Stats */
  .stats {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .stat-card {
    background: var(--lighter);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    min-width: 120px;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--gray);
  }

  /* Grid and Cards */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
  }

  .card {
    background: var(--lighter);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    border: 1px solid transparent;
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
  }

  .card-header {
    margin-bottom: 14px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .card-favicon {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    object-fit: contain;
    flex-shrink: 0;
  }

  .card-title h3 {
    margin: 0 0 6px 0;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--darker);
    line-height: 1.3;
  }

  .card-title .card-url {
    margin: 0;
    font-size: 0.85rem;
    color: var(--gray);
    word-break: break-all;
  }

  .card-description {
    margin: 0 0 16px;
    color: var(--dark);
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
  }

  .tag {
    font-size: 0.75rem;
    padding: 6px 10px;
    border-radius: 20px;
    background: rgba(67, 97, 238, 0.1);
    color: var(--primary);
    font-weight: 500;
  }

  .category-tag {
    background: rgba(247, 37, 133, 0.1);
    color: var(--warning);
  }

  .card-actions {
    display: flex;
    gap: 8px;
    margin-top: auto;
  }

  .card-action {
    flex: 1;
    background: transparent;
    border: 1px solid var(--gray-lighter);
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85rem;
    color: var(--dark);
    transition: var(--transition);
    text-align: center;
  }

  .card-action:hover {
    background: rgba(67, 97, 238, 0.05);
    border-color: var(--primary-light);
    color: var(--primary);
  }

  .card-action.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .card-action.primary:hover {
    background: var(--primary-light);
    border-color: var(--primary-light);
  }

  /* Empty State */
  .empty-state {
    grid-column: 1 / -1;
    padding: 60px 20px;
    text-align: center;
    color: var(--gray);
  }

  .empty-state h3 {
    font-size: 1.4rem;
    margin-bottom: 12px;
    color: var(--dark);
  }

  .empty-state p {
    max-width: 500px;
    margin: 0 auto;
  }

  /* Footer */
  footer {
    margin-top: 40px;
    padding: 20px 0;
    color: var(--gray);
    font-size: 0.9rem;
    text-align: center;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
  }

  /* Modal Styles */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    padding: 20px;
    backdrop-filter: blur(4px);
  }

  .modal {
    width: 100%;
    max-width: 1100px;
    background: var(--lighter);
    border-radius: var(--radius);
    padding: 0;
    height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--gray-lighter);
  }

  .modal-header h2 {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--darker);
  }

  .modal-url {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 4px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .modal iframe {
    border: 0;
    flex: 1;
    background: var(--lighter);
  }

  /* Form Modal */
  .form-modal .modal {
    max-width: 700px;
    height: auto;
    max-height: 90vh;
    overflow-y: auto;
  }

  .form-body {
    padding: 24px;
  }

  .form-row {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
  }

  .form-row:last-child {
    margin-bottom: 0;
  }

  .form-group {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 8px;
    color: var(--dark);
  }

  .form-group input, 
  .form-group select, 
  .form-group textarea {
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--gray-lighter);
    font-size: 0.95rem;
    background: var(--lighter);
    transition: var(--transition);
  }

  .form-group input:focus, 
  .form-group select:focus, 
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-help {
    font-size: 0.85rem;
    color: var(--gray);
    margin-top: 20px;
    line-height: 1.5;
  }

  /* Toast notifications */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--darker);
    color: white;
    padding: 12px 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    z-index: 1100;
    display: flex;
    align-items: center;
    gap: 10px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .toast.success {
    background: var(--success);
  }

  .toast.error {
    background: var(--warning);
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .grid {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
  }

  @media (max-width: 768px) {
    .app-container {
      padding: 16px;
    }

    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 20px;
    }

    .controls {
      width: 100%;
      justify-content: flex-end;
    }

    .filters {
      flex-direction: column;
      align-items: stretch;
    }

    .search {
      width: 100%;
    }

    select.category {
      width: 100%;
    }

    .form-row {
      flex-direction: column;
      gap: 16px;
    }

    .card-actions {
      flex-wrap: wrap;
    }

    .card-action {
        min-width: calc(50% - 4px);
    }

    .stats {
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .brand {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .logo {
      width: 50px;
      height: 50px;
    }

    .code-symbol {
      font-size: 1.5rem;
    }

    .brand-text h1 {
      font-size: 1.5rem;
    }

    .modal-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }

    .modal-actions {
      width: 100%;
      justify-content: flex-end;
    }
  }
</style>
</head>
<body>
  <div class="app-container" role="main" aria-label="Jay's Coding Hub">
    <header>
      <div class="brand">
        <div class="logo">
          <div class="logo-inner">
            <div class="code-symbol"></div>
          </div>
        </div>
        <div class="brand-text">
          <h1>Jay's Coding Hub</h1>
          <div class="subtitle">A curated collection of web utilities and development tools</div>
        </div>
      </div>
      
      <button id="resetBtn" class="btn secondary">Reset</button>

      <div class="controls">
        <button id="exportBtn" class="btn secondary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Export
        </button>
        <button id="importBtn" class="btn secondary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Import
        </button>
        <button id="addBtn" class="btn primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Tool
        </button>
      </div>
    </header>

    <div class="stats" role="region" aria-label="Tool statistics">
      <div class="stat-card">
        <div class="stat-value" id="totalTools">0</div>
        <div class="stat-label">Total Tools</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalCategories">0</div>
        <div class="stat-label">Categories</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalTags">0</div>
        <div class="stat-label">Tags</div>
      </div>
    </div>

    <div class="filters" role="region" aria-label="Search and filter tools">
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input id="q" placeholder="Search tools by name, description, or tags..." aria-label="Search tools" />
      </div>
      <select id="categoryFilter" class="category" aria-label="Filter by category">
        <option value="">All Categories</option>
      </select>
    </div>

    <div class="tag-filters" role="region" aria-label="Filter by tags">
      <span>Filter by tags:</span>
      <div id="tagFilters"></div>
      <span id="clearTags" class="clear-tags" style="display: none;">Clear all</span>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <footer>
      <p>Tip: Keep a <code>tools.json</code> file in your repository for a canonical list and use Import to load it locally.</p>
    </footer>
  </div>

  <!-- Preview Modal -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Tool Preview</h2>
          <div id="modalUrl" class="modal-url"></div>
        </div>
        <div class="modal-actions">
          <button id="openNewTab" class="btn secondary">Open in New Tab</button>
          <button id="closeModal" class="btn primary">Close</button>
        </div>
      </div>
      <iframe id="previewFrame" src="" title="Tool preview"></iframe>
    </div>
  </div>

  <!-- Add/Edit Form Modal -->
  <div id="formModal" class="modal-backdrop form-modal" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <h2 id="formTitle">Add New Tool</h2>
        <div class="modal-actions">
          <button id="saveTool" class="btn primary">Save Tool</button>
          <button id="cancelTool" class="btn secondary">Cancel</button>
        </div>
      </div>
      <div class="form-body">
        <div class="form-row">
          <div class="form-group">
            <label for="toolName">Tool Name</label>
            <input id="toolName" placeholder="e.g., Code Italiciser" />
          </div>
          <div class="form-group">
            <label for="toolUrl">Tool URL</label>
            <input id="toolUrl" placeholder="https://example.com/tool" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="toolDescription">Description</label>
            <input id="toolDescription" placeholder="Brief description of what this tool does" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="toolTags">Tags</label>
            <input id="toolTags" placeholder="Comma-separated tags (e.g., html, code, utility)" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="toolCategory">Category</label>
            <select id="toolCategory">
              <option value="">Select a category</option>
              <option value="GIS / Mapping">GIS / Mapping</option>
              <option value="Data Processing">Data Processing</option>
              <option value="Export / CSV / JSON / PDF">Export / CSV / JSON / PDF</option>
              <option value="Ecosystem Modeling">Ecosystem Modeling</option>
              <option value="UI Components">UI Components</option>
              <option value="Development Tools">Development Tools</option>
              <option value="Text Tools">Text Tools</option>
              <option value="Photography Tools">Photography Tools</option>
              <option value="Teaching / Worksheets">Teaching / Worksheets</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="toolFavicon">Favicon URL (Optional)</label>
            <input id="toolFavicon" placeholder="Leave blank to auto-fetch" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="toolNotes">Notes (Optional)</label>
            <textarea id="toolNotes" placeholder="Any additional notes about this tool"></textarea>
          </div>
        </div>
        <div class="form-help">
          <p>Entries are stored locally in your browser by default. Use Export/Import to maintain a repository-level <code>tools.json</code> file.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <span id="toastMessage"></span>
  </div>

<script>
/* ---------- Data + initial tools ---------- */
function cryptoRandomId(){ return 'id-' + Math.random().toString(36).slice(2,9); }

// Enhanced starter structure with categories tailored to environmental/ecosystem projects
const DEFAULT_TOOLS = [
  {
    id: cryptoRandomId(),
    name: "Code Italiciser",
    url: "https://jaysecotools.github.io/CodeItaliciser/",
    description: "Adds <em>/<i> to scientific names and legislations in HTML.",
    tags: ["html","italicise","code", "text-processing"],
    category: "Text Tools",
    favicon: "",
    notes: "Useful for academic papers with species names"
  },
    {
    id: cryptoRandomId(),
    name: "Smart Code Inspector",
    url: "https://jaysecotools.github.io/Smart-Code-Inspector/",
    description: "Quick local HTML test harness.",
    tags: ["html","test", "development"],
    category: "Development Tools",
    favicon: "",
    notes: ""
  },
  {
    id: cryptoRandomId(),
    name: "Offline HTML tester",
    url: "https://jaysecotools.github.io/Offline-HTML-tester/",
    description: "Quick local HTML test harness.",
    tags: ["html","test", "development"],
    category: "Development Tools",
    favicon: "",
    notes: ""
  },
  {
    id: cryptoRandomId(),
    name: "Web Code Separator",
    url: "https://jaysecotools.github.io/WebCodeSeparator/",
    description: "Split markup, CSS and scripts for editing.",
    tags: ["split","code", "development"],
    category: "Development Tools",
    favicon: "",
    notes: ""
  },
  {
    id: cryptoRandomId(),
    name: "Code Cleaner & Beautifier",
    url: "https://jaysecotools.github.io/CodeCleanerBeautifier/",
    description: "Clean and beautify code.",
    tags: ["clean","code", "beautify", "development"],
    category: "Development Tools",
    favicon: "",
    notes: ""
  },
  {
    id: cryptoRandomId(),
    name: "Coding Snippet Library",
    url: "https://jaysecotools.github.io/CodeSnippetLibraryV2/",
    description: "Search for code snippets to use in development.",
    tags: ["snippet","code", "development"],
    category: "Development Tools",
    favicon: "",
    notes: ""
  },
  // Sample environmental tools
  {
    id: cryptoRandomId(),
    name: "Ecosystem Simulator",
    url: "https://example.com/ecosystem-simulator",
    description: "Simulate population dynamics in ecological systems.",
    tags: ["simulation", "ecology", "modeling", "data-visualization"],
    category: "Ecosystem Modeling",
    favicon: "",
    notes: "Based on Lotka-Volterra equations"
  },
  {
    id: cryptoRandomId(),
    name: "CSV to GeoJSON Converter",
    url: "https://example.com/csv-to-geojson",
    description: "Convert CSV data with coordinates to GeoJSON format.",
    tags: ["gis", "conversion", "data-processing", "mapping"],
    category: "GIS / Mapping",
    favicon: "",
    notes: "Supports WGS84 coordinate system"
  },
  {
    id: cryptoRandomId(),
    name: "Data Export Tool",
    url: "https://example.com/data-export",
    description: "Export datasets to CSV, JSON, and PDF formats.",
    tags: ["export", "csv", "json", "pdf", "data-processing"],
    category: "Export / CSV / JSON / PDF",
    favicon: "",
    notes: "Includes data validation"
  }
];

const STORAGE_KEY = 'jay_tools_hub_v4';

/* ---------- DOM refs ---------- */
const grid = document.getElementById('grid');
const q = document.getElementById('q');
const categoryFilter = document.getElementById('categoryFilter');
const tagFilters = document.getElementById('tagFilters');
const clearTags = document.getElementById('clearTags');
const addBtn = document.getElementById('addBtn');
const modal = document.getElementById('modal');
const previewFrame = document.getElementById('previewFrame');
const modalTitle = document.getElementById('modalTitle');
const modalUrl = document.getElementById('modalUrl');
const closeModal = document.getElementById('closeModal');
const openNewTab = document.getElementById('openNewTab');

const formModal = document.getElementById('formModal');
const formTitle = document.getElementById('formTitle');
const toolName = document.getElementById('toolName');
const toolUrl = document.getElementById('toolUrl');
const toolDescription = document.getElementById('toolDescription');
const toolTags = document.getElementById('toolTags');
const toolCategory = document.getElementById('toolCategory');
const toolFavicon = document.getElementById('toolFavicon');
const toolNotes = document.getElementById('toolNotes');
const saveTool = document.getElementById('saveTool');
const cancelTool = document.getElementById('cancelTool');

const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');

const totalTools = document.getElementById('totalTools');
const totalCategories = document.getElementById('totalCategories');
const totalTags = document.getElementById('totalTags');

const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');

let tools = loadTools();
let editId = null;
let activeTags = [];

/* ---------- Boot ---------- */
render();
populateCategoryFilter();
populateTagFilters();
updateStats();

q.addEventListener('input', render);
categoryFilter.addEventListener('change', render);
addBtn.addEventListener('click', openAddForm);
closeModal.addEventListener('click', closePreview);
openNewTab.addEventListener('click', () => {
  if (previewFrame.src) window.open(previewFrame.src, '_blank', 'noopener');
});

clearTags.addEventListener('click', () => {
  activeTags = [];
  clearTags.style.display = 'none';
  render();
});

/* form handlers */
saveTool.addEventListener('click', () => {
  const name = toolName.value.trim();
  const urlVal = toolUrl.value.trim();
  if (!name || !urlVal) {
    showToast('Please provide at least a name and URL.', 'error');
    return;
  }
  const obj = {
    id: editId || cryptoRandomId(),
    name,
    url: urlVal,
    description: toolDescription.value.trim(),
    tags: toolTags.value.split(',').map(s=>s.trim()).filter(Boolean),
    category: toolCategory.value.trim(),
    favicon: toolFavicon.value.trim() || '',
    notes: toolNotes.value.trim()
  };
  
  if (editId) {
    tools = tools.map(t => t.id === editId ? obj : t);
    showToast('Tool updated successfully!', 'success');
  } else {
    tools.unshift(obj);
    showToast('Tool added successfully!', 'success');
  }
  
  saveTools();
  closeForm();
  render();
  populateCategoryFilter();
  populateTagFilters();
  updateStats();
});

cancelTool.addEventListener('click', closeForm);

exportBtn.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(tools, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tools.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Tools exported successfully!', 'success');
});

importBtn.addEventListener('click', async () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,application/json';
  input.onchange = async () => {
    const file = input.files[0];
    if (!file) return;
    try {
      const txt = await file.text();
      const parsed = JSON.parse(txt);
      if (!Array.isArray(parsed)) throw new Error('Invalid format: expected an array');
      const valid = parsed.every(p => p && p.name && p.url);
      if (!valid) throw new Error('Missing required fields for some tools.');
      if (!confirm('Import will replace your local hub entries. Continue?')) return;
      tools = parsed.map(t => ({...t, id: t.id || cryptoRandomId(), favicon: t.favicon || ''}));
      saveTools();
      render();
      populateCategoryFilter();
      populateTagFilters();
      updateStats();
      showToast('Tools imported successfully!', 'success');
    } catch (e) {
      showToast('Failed to import: ' + e.message, 'error');
    }
  };
  input.click();
});

/* ---------- Functions ---------- */
function loadTools(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e){}
  return DEFAULT_TOOLS.slice();
}

function saveTools(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tools));
}

function render(){
  const term = q.value.trim().toLowerCase();
  const category = categoryFilter.value;
  grid.innerHTML = '';
  const filtered = tools.filter(t => {
    if (category && (t.category || '') !== category) return false;
    if (activeTags.length > 0 && !activeTags.some(tag => (t.tags || []).includes(tag))) return false;
    if (!term) return true;
    const hay = (t.name + ' ' + (t.description||'') + ' ' + (t.tags||[]).join(' ') + ' ' + (t.category||'')).toLowerCase();
    return hay.includes(term);
  });
  
  if (!filtered.length){
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.innerHTML = `
      <h3>No tools found</h3>
      <p>Try adjusting your search or add a new tool to get started.</p>
    `;
    grid.appendChild(empty);
    return;
  }
  
  filtered.forEach(t => {
    const card = document.createElement('article');
    card.className = 'card';
    card.tabIndex = 0;

    const cardHeader = document.createElement('div');
    cardHeader.className = 'card-header';

    // Try to get favicon
    let faviconUrl = t.favicon;
    if (!faviconUrl && t.url) {
      try {
        const urlObj = new URL(t.url);
        faviconUrl = `${urlObj.origin}/favicon.ico`;
      } catch(e) {
        // Invalid URL, skip favicon
      }
    }

    if (faviconUrl) {
      const favicon = document.createElement('img');
      favicon.className = 'card-favicon';
      favicon.src = faviconUrl;
      favicon.alt = '';
      favicon.onerror = () => {
        // If favicon fails to load, remove the element
        favicon.remove();
      };
      cardHeader.appendChild(favicon);
    }

    const titleContainer = document.createElement('div');
    titleContainer.className = 'card-title';
    
    const title = document.createElement('h3');
    title.textContent = t.name;
    
    const url = document.createElement('p');
    url.className = 'card-url';
    url.textContent = t.url;
    
    titleContainer.appendChild(title);
    titleContainer.appendChild(url);
    cardHeader.appendChild(titleContainer);

    const description = document.createElement('p');
    description.className = 'card-description';
    description.textContent = t.description || 'No description provided.';

    const tagsContainer = document.createElement('div');
    tagsContainer.className = 'card-tags';
    
    if (t.tags && t.tags.length) {
      t.tags.slice(0,4).forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'tag';
        tagEl.textContent = tag;
        tagEl.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleTagFilter(tag);
        });
        tagsContainer.appendChild(tagEl);
      });
    }
    
    if (t.category) {
      const catTag = document.createElement('span');
      catTag.className = 'tag category-tag';
      catTag.textContent = t.category;
      tagsContainer.appendChild(catTag);
    }

    const actions = document.createElement('div');
    actions.className = 'card-actions';
    
    const preview = document.createElement('button');
    preview.className = 'card-action primary';
    preview.title = 'Preview';
    preview.ariaLabel = 'Preview ' + t.name;
    preview.textContent = 'Preview';
    preview.onclick = () => openPreview(t);

    const open = document.createElement('button');
    open.className = 'card-action';
    open.title = 'Open in new tab';
    open.textContent = 'Open';
    open.onclick = () => window.open(t.url, '_blank', 'noopener');

    const edit = document.createElement('button');
    edit.className = 'card-action';
    edit.title = 'Edit entry';
    edit.textContent = 'Edit';
    edit.onclick = () => openEditForm(t);

    const del = document.createElement('button');
    del.className = 'card-action';
    del.title = 'Remove from hub';
    del.textContent = 'Delete';
    del.onclick = () => {
      if (!confirm('Delete "'+t.name+'"?')) return;
      tools = tools.filter(x => x.id !== t.id);
      saveTools();
      render();
      populateCategoryFilter();
      populateTagFilters();
      updateStats();
      showToast('Tool deleted successfully!', 'success');
    };

    actions.appendChild(preview);
    actions.appendChild(open);
    actions.appendChild(edit);
    actions.appendChild(del);

    card.appendChild(cardHeader);
    card.appendChild(description);
    card.appendChild(tagsContainer);
    card.appendChild(actions);

    grid.appendChild(card);
  });
}

function populateCategoryFilter(){
  const cats = Array.from(new Set(tools.map(t => t.category || '').filter(Boolean))).sort();
  categoryFilter.innerHTML = '<option value="">All categories</option>';
  cats.forEach(c => {
    const o = document.createElement('option');
    o.value = c;
    o.textContent = c;
    categoryFilter.appendChild(o);
  });
}

function populateTagFilters(){
  const allTags = [];
  tools.forEach(t => {
    if (t.tags && t.tags.length) {
      allTags.push(...t.tags);
    }
  });
  
  const uniqueTags = Array.from(new Set(allTags)).sort();
  tagFilters.innerHTML = '';
  
  uniqueTags.forEach(tag => {
    const tagEl = document.createElement('span');
    tagEl.className = 'tag-filter';
    if (activeTags.includes(tag)) {
      tagEl.classList.add('active');
    }
    tagEl.textContent = tag;
    tagEl.addEventListener('click', () => toggleTagFilter(tag));
    tagFilters.appendChild(tagEl);
  });
  
  if (activeTags.length > 0) {
    clearTags.style.display = 'inline';
  } else {
    clearTags.style.display = 'none';
  }
}

function toggleTagFilter(tag) {
  if (activeTags.includes(tag)) {
    activeTags = activeTags.filter(t => t !== tag);
  } else {
    activeTags.push(tag);
  }
  populateTagFilters();
  render();
}

function updateStats() {
  const categories = new Set(tools.map(t => t.category || '').filter(Boolean));
  const allTags = [];
  tools.forEach(t => {
    if (t.tags && t.tags.length) {
      allTags.push(...t.tags);
    }
  });
  const uniqueTags = new Set(allTags);
  
  totalTools.textContent = tools.length;
  totalCategories.textContent = categories.size;
  totalTags.textContent = uniqueTags.size;
}

function openPreview(tool){
  previewFrame.src = tool.url;
  modalTitle.textContent = tool.name;
  modalUrl.textContent = tool.url;
  openNewTab.onclick = () => window.open(tool.url, '_blank', 'noopener');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
  previewFrame.focus();
}

function closePreview(){
  previewFrame.src = '';
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
}

function openAddForm(){
  editId = null;
  formTitle.textContent = 'Add new tool';
  toolName.value = toolUrl.value = toolDescription.value = toolTags.value = toolFavicon.value = toolNotes.value = '';
  toolCategory.value = '';
  formModal.style.display = 'flex';
  formModal.setAttribute('aria-hidden','false');
  toolName.focus();
}

function openEditForm(t){
  editId = t.id;
  formTitle.textContent = 'Edit tool';
  toolName.value = t.name || '';
  toolUrl.value = t.url || '';
  toolDescription.value = t.description || '';
  toolTags.value = (t.tags || []).join(', ');
  toolCategory.value = t.category || '';
  toolFavicon.value = t.favicon || '';
  toolNotes.value = t.notes || '';
  formModal.style.display = 'flex';
  formModal.setAttribute('aria-hidden','false');
  toolName.focus();
}

function closeForm(){
  editId = null;
  formModal.style.display = 'none';
  formModal.setAttribute('aria-hidden','true');
}

function showToast(message, type = 'success') {
  toastMessage.textContent = message;
  toast.className = 'toast';
  toast.classList.add(type);
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

/* Reset button added to refresh page local storage */
document.getElementById('resetBtn').addEventListener('click', () => {
  if (confirm('Reset to default tools? This will clear your local changes.')) {
    localStorage.removeItem(STORAGE_KEY);
    tools = DEFAULT_TOOLS.slice();
    saveTools();
    render();
    populateCategoryFilter();
    populateTagFilters();
    updateStats();
    showToast('Reset to default tools!', 'success');
  }
});

/* Accessibility: close modals on Escape */
document.addEventListener('keydown', (ev) => {
  if (ev.key === 'Escape') {
    if (modal.style.display === 'flex') closePreview();
    if (formModal.style.display === 'flex') closeForm();
  }
});

/* Initialise localStorage if empty (save defaults) */
(function ensureSeeded(){
  try {
    if (!localStorage.getItem(STORAGE_KEY)) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_TOOLS));
      tools = DEFAULT_TOOLS.slice();
    }
  } catch(e){}
})();
</script>
</body>
</html>
